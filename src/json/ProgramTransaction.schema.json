{
    "$schema": "http://json-schema.org/draft-04/schema#",
    "title": "Program Transaction Schema",
    "description": "Establishes the transaction interface that programs use apply mutations/generate analytics.",
    "type": "object",
    "properties": {
        "programId": {
            "type": "string",
            "title": "Program Identifier"
        },
        "mutations": {
            "type": "array",
            "title": "Mutations",
            "description": "These are actions we would like to be performed by the program engine (i.e. creating a reward or sending an email)",
            "items": {
                "$ref": "#/definitions/mutation"
            }
        }
    },
    "additionalProperties": false,
    "required": [
        "programId"
    ],
    "definitions": {
        "mutation": {
            "type": "object",
            "title": "Program Mutation",
            "properties": {
                "type": {
                    "type": "string",
                    "title": "Mutation Type",
                    "description": "The type of mutation to be performed",
                    "enum": [
                        "CREATE_REWARD",
                        "SEND_EMAIL",
                        "MODERATE_GRAPH_NODES"
                    ]
                }
            },
            "dependencies": {
                "type": {
                    "oneOf": [
                        {
                            "properties": {
                                "type": {
                                    "enum": [
                                        "CREATE_REWARD"
                                    ]
                                },
                                "key": {
                                    "type": "string",
                                    "title": "Reward Key",
                                    "description": "The program template key used to establish the relationship between this reward and the program"
                                },
                                "rewardId": {
                                    "type": "string",
                                    "title": "Reward ID",
                                    "description": "A unique BSON ObjectID used to identify the reward, if not set this will be auto-generated. Use this to link with emails."
                                },
                                "referralId": {
                                    "type": "string",
                                    "title": "Referral ID",
                                    "description": "The referral ID for the event to be marked as a source of this reward"
                                },
                                "user": {
                                    "type": "object",
                                    "title": "Rewarded User",
                                    "description": "The user that will receive this reward",
                                    "properties": {
                                        "id": {
                                            "type": "string",
                                            "title": "User ID"
                                        },
                                        "accountId": {
                                            "type": "string",
                                            "title": "User Account ID"
                                        }
                                    },
                                    "additionalProperties": false,
                                    "required": [
                                        "id",
                                        "accountId"
                                    ]
                                },
                                "userEvent": {
                                    "type": "object",
                                    "properties": {
                                        "key": {
                                            "type": "string",
                                            "title": "Event Key",
                                            "description": "The key of the event to be marked as a source of this reward"
                                        },
                                        "id": {
                                            "type": "string",
                                            "title": "Event ID",
                                            "description": "The unique identifier of the event to be marked as a source of this reward"
                                        }
                                    },
                                    "additionalProperties": false,
                                    "required": [
                                        "key",
                                        "id"
                                    ]
                                },
                                "rewardProperties": {
                                    "type": "object",
                                    "title": "Reward Properties",
                                    "description": "Reward properties may be fully or partially set depending on whether the reward is configured as dynamic",
                                    "oneOf":[
                                        {
                                            "properties": {
                                                "override": {
                                                    "type": "object",
                                                    "properties": {
                                                        "dateScheduledFor": {
                                                            "type": "integer",
                                                            "title": "Scheduled Reward Given Date",
                                                            "description": "If the reward is created in a PENDING state this is the date we will attempt to 'give' it"
                                                        },
                                                        "dateExpires": {
                                                            "type": "integer",
                                                            "title": "Reward Expiry Date",
                                                            "description": "The date this reward is scheduled to expire"
                                                        }
                                                    },
                                                    "additionalProperties": false
                                                }
                                            },
                                            "required":[
                                                "override"
                                            ]
                                        },
                                        {
                                            "properties": {
                                                "dynamic": {
                                                    "type": "object",
                                                    "properties": {
                                                        "type": {
                                                            "type": "string"
                                                        }
                                                    },
                                                    "additionalProperties": false
                                                }
                                            },
                                            "required":[
                                                "dynamic"
                                            ]
                                        }
                                    ]
                                }
                            },
                            "additionalProperties": false,
                            "required": [
                                "type",
                                "user"
                            ]
                        },
                        {
                            "properties": {
                                "type": {
                                    "enum": [
                                        "SEND_EMAIL"
                                    ]
                                }
                            }
                        }
                    ]
                }
            }
        }
    }
}